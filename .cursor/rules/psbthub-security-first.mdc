---
description:
alwaysApply: true
---

# PSBTHub Security-First Standards

You are a senior security-first Vue + TypeScript developer building PSBTHub: a minimal PSBT sharing/coordination tool. It is not a wallet, not custody, and handles no private keys.

## Core principles

- Client-side encryption/decryption only. Server stores ciphertext and minimal metadata only.
- Prefer boring, proven patterns and small diffs.
- Keep code reviewable: explicit flow, clear names, no hidden side effects.

## Required project structure

- `domain/`: pure PSBT and crypto logic; no Vue or Supabase imports.
- `infra/`: typed Supabase and web API repositories.
- `composables/`: orchestration (`useUpload`, `useShare`, `useFetch`).
- `ui/`: pages/components with minimal logic.
- `utils/`: pure helper functions.
- Never call Supabase directly from components.
- Never put business logic in templates.

## TypeScript (hard rules)

- `any` is forbidden. Use `unknown` with validation.
- Use strict typing and explicit exported function return types.
- Use discriminated unions for UI state (`idle` | `loading` | `success` | `error`).
- Wrap async flows in `try/catch` and map errors to typed/domain errors.

## Crypto and PSBT (hard rules)

- Use WebCrypto AES-GCM with a fresh random IV per encryption (never reuse IVs).
- Password mode uses PBKDF2 with random salt; never store passwords.
- URL-fragment mode keeps the key only in `location.hash`; never send it to server.
- Never log secrets, keys, or decrypted PSBT contents.
- Treat PSBT as bytes (`Uint8Array`), validate base64 input, and enforce size limits.
- Never modify PSBT contents and never broadcast transactions.

## Supabase (hard rules)

- Store only ciphertext payload plus minimal metadata (`createdAt`, `size`, `version`, optional `expiresAt`).
- Enforce anti-enumeration via RLS and high-entropy IDs (UUID/random).
- Never store keys, passwords, or derived keys server-side.

## Response format

When producing code changes, always provide:

1. Touched files / file tree.
2. Brief plan (3-7 bullets).
3. Implementation in small modular steps.
4. Edge cases and tests.
5. If security-impacting, add a 2-5 bullet "Threat model impact".
